<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>双扣记牌器</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            color: #ff4500;
        }
        .control-buttons {
            margin: 10px 0;
            display: flex;
            gap: 10px;
        }
        .control-buttons button {
            padding: 10px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
        }
        .control-buttons button:hover {
            background-color: #0056b3;
        }
        .board {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 10px;
            width: 100%;
            max-width: 400px;
        }
        .row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .player {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 90px;
            height: 150px;
            margin: 10px;
            cursor: pointer;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 5px;
            background-color: #f8f9fa;
            transition: background-color 0.3s;
            text-align: center;
        }
        .player:hover {
            background-color: #e9ecef;
        }
        .player.active {
            background-color: #007bff;
            color: white;
        }
        .player h2 {
            font-size: 18px;
            margin: 5px 0;
        }
        .player .remaining {
            font-size: 14px;
            margin-top: 5px;
            color: #555;
        }
        .player .history,
        .player .total-played {
            font-size: 14px;
            color: #000;
            text-align: left;
            width: 90%;
            margin-top: 5px;
            overflow-y: auto;
            height: 60px;
        }
        .center-board {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 400px;
        }
        .card-board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin: 10px 0;
        }
        .card {
            width: 60px;
            height: 60px;
            font-size: 18px;
            font-weight: bold;
            line-height: 60px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            background-color: white;
        }
        .card.used {
            background-color: #999;
            color: white;
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin: 10px 0;
            gap: 5px;
        }
        .button-group button {
            padding: 10px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .pairs { background-color: #1e90ff; color: white; }
        .triplets { background-color: #32cd32; color: white; }
        .sequence { background-color: #ffa500; color: white; }
        .bomb { background-color: #dc143c; color: white; }
        .record {
            background-color: #ff4500; color: white;
        }
        .record:hover {
            background-color: #d03c00;
        }
        .active {
            box-shadow: 0 0 10px 2px #666;
        }
        .round {
            font-size: 16px;
            margin-top: 5px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>双扣记牌器</h1>
    <div class="control-buttons">
        <button onclick="undo()">撤销</button>
        <button onclick="redo()">前进</button>
        <button onclick="reset()">重置</button>
        <button onclick="activateSubtractMode()">减牌</button>
    </div>
    <div class="round" id="round">当前轮次：第 1 轮</div>
    <!-- 玩家布局 -->
    <div class="board">
        <div class="player" id="north" onclick="recordPlay('north')">
            <h2>北家（<span id="remaining-north">27</span>）</h2>
            <div class="history" id="history-north"></div>
            <div class="total-played" id="total-north">已打出：无</div>
        </div>
        <div class="row">
            <div class="player" id="west" onclick="recordPlay('west')">
                <h2>西家（<span id="remaining-west">27</span>）</h2>
                <div class="history" id="history-west"></div>
                <div class="total-played" id="total-west">已打出：无</div>
            </div>
            <div class="center-board">
                <div class="card-board" id="card-board">
                    <!-- 卡牌动态生成 -->
                </div>
                <div class="button-group">
                    <button class="pairs" onclick="togglePlayType(this, '对子', '#1e90ff', 2)">对子</button>
                    <button class="triplets" onclick="togglePlayType(this, '三张', '#32cd32', 3)">三张</button>
                    <button class="sequence" onclick="togglePlayType(this, '一条龙', '#ffa500')">一条龙</button>
                    <button class="sequence" onclick="togglePlayType(this, '连对', '#1e90ff', 2)">连对</button>
                    <button class="bomb" onclick="togglePlayType(this, '炸弹4', '#dc143c', 4)">炸弹4</button>
                    <button class="bomb" onclick="togglePlayType(this, '炸弹5', '#dc143c', 5)">炸弹5</button>
                    <button class="bomb" onclick="togglePlayType(this, '炸弹6', '#dc143c', 6)">炸弹6</button>
                    <button class="bomb" onclick="togglePlayType(this, '炸弹7', '#dc143c', 7)">炸弹7</button>
                    <button class="bomb" onclick="togglePlayType(this, '炸弹8', '#dc143c', 8)">炸弹8</button>
                </div>
            </div>
            <div class="player" id="east" onclick="recordPlay('east')">
                <h2>东家（<span id="remaining-east">27</span>）</h2>
                <div class="history" id="history-east"></div>
                <div class="total-played" id="total-east">已打出：无</div>
            </div>
        </div>
        <div class="player" id="south" onclick="recordPlay('south')">
            <h2>南家（<span id="remaining-south">27</span>）</h2>
            <div class="history" id="history-south"></div>
            <div class="total-played" id="total-south">已打出：无</div>
        </div>
    </div>

    <script>
        const ranks = ["3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K", "A", "2", "小王", "大王"];
        const initialCards = 27;
        const players = ["north", "south", "west", "east"];
        const histories = { north: [], south: [], west: [], east: [] };
        const totalPlayed = { north: [], south: [], west: [], east: [] };
        const remainingCards = { north: initialCards, south: initialCards, west: initialCards, east: initialCards };
        let playType = null;
        let playColor = null;
        let playCount = null;
        let currentRound = 1;
        let historyStack = [];
        let redoStack = [];
        let subtractMode = false;

        const cardBoard = document.getElementById("card-board");
        const roundDisplay = document.getElementById("round");

        // 动态生成卡牌
        ranks.forEach(rank => {
            const card = document.createElement("div");
            card.className = "card";
            card.textContent = rank;
            card.dataset.rank = rank;
            card.addEventListener("click", () => {
                card.classList.toggle("used");
            });
            cardBoard.appendChild(card);
        });

        function togglePlayType(button, type, color, count = null) {
            if (playType === type) {
                playType = null;
                playColor = null;
                playCount = null;
                button.classList.remove("active");
            } else {
                playType = type;
                playColor = color;
                playCount = count;

                document.querySelectorAll(".button-group button").forEach(btn => btn.classList.remove("active"));
                button.classList.add("active");
            }
        }

        function activateSubtractMode() {
            subtractMode = true;
            alert("已启用减牌模式，点击玩家头像以移除选中牌。");
        }

        function recordPlay(player) {
            if (subtractMode) {
                subtractCards(player);
                subtractMode = false;
                return;
            }

            const selectedCards = Array.from(document.querySelectorAll(".card.used"));
            if (selectedCards.length === 0) return alert("请选择要打出的牌！");

            let playDescription = '';
            let totalCards = 0;

            if (playType === "一条龙") {
                const startIndex = ranks.indexOf(selectedCards[0].dataset.rank);
                const endIndex = ranks.indexOf(selectedCards[selectedCards.length - 1].dataset.rank);
                const range = ranks.slice(Math.min(startIndex, endIndex), Math.max(startIndex, endIndex) + 1);
                playDescription = `<span style="color: ${playColor};">(${currentRound}) ${range.join(" ")}</span>`;
                totalCards = range.length;
                totalPlayed[player].push(...range);
            } else if (playType === "连对") {
                const startIndex = ranks.indexOf(selectedCards[0].dataset.rank);
                const endIndex = ranks.indexOf(selectedCards[selectedCards.length - 1].dataset.rank);
                const pairs = ranks.slice(Math.min(startIndex, endIndex), Math.max(startIndex, endIndex) + 1).flatMap(rank => [rank, rank]);
                playDescription = `<span style="color: ${playColor};">(${currentRound}) ${pairs.join(" ")}</span>`;
                totalCards = pairs.length;
                totalPlayed[player].push(...pairs);
            } else {
                const multiplier = playCount || 1;
                const cards = selectedCards.flatMap(card => Array(multiplier).fill(card.dataset.rank));
                playDescription = `<span style="color: ${playColor || "#999"};">(${currentRound}) ${cards.join(" ")}</span>`;
                totalCards = cards.length;
                totalPlayed[player].push(...cards);
            }

            // 更新总出牌列表
            totalPlayed[player].sort((a, b) => ranks.indexOf(a) - ranks.indexOf(b));
            document.getElementById(`total-${player}`).textContent = `已打出：${totalPlayed[player].join("")}`;

            histories[player].push(playDescription);
            document.getElementById(`history-${player}`).innerHTML = histories[player].join(" ");

            historyStack.push({ player, playDescription, totalCards });
            redoStack = [];

            remainingCards[player] -= totalCards;
            document.getElementById(`remaining-${player}`).textContent = remainingCards[player];

            selectedCards.forEach(card => card.classList.remove("used"));
            currentRound++;
            roundDisplay.textContent = `当前轮次：第 ${currentRound} 轮`;

            playType = null;
            playColor = null;
            playCount = null;
            document.querySelectorAll(".button-group button").forEach(btn => btn.classList.remove("active"));
        }

        function subtractCards(player) {
            const selectedCards = Array.from(document.querySelectorAll(".card.used"));
            if (selectedCards.length === 0) return alert("请选择要移除的牌！");

            const selectedRanks = selectedCards.map(card => card.dataset.rank);
            totalPlayed[player] = totalPlayed[player].filter(rank => !selectedRanks.includes(rank));
            document.getElementById(`total-${player}`).textContent = `已打出：${totalPlayed[player].join("")}`;

            remainingCards[player] += selectedRanks.length;
            document.getElementById(`remaining-${player}`).textContent = remainingCards[player];

            selectedCards.forEach(card => card.classList.remove("used"));
            alert("选中牌已移除！");
        }
    </script>
</body>
</html>
